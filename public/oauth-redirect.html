<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>OAuth Redirect</title>
	<style>
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			display: flex;
			align-items: center;
			justify-content: center;
			height: 100vh;
			margin: 0;
			background: #f5f5f5;
		}
		.message {
			text-align: center;
			color: #666;
		}
		.spinner {
			border: 2px solid #f3f3f3;
			border-top: 2px solid #6A8BA7;
			border-radius: 50%;
			width: 24px;
			height: 24px;
			animation: spin 1s linear infinite;
			margin: 0 auto 16px;
		}
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
	</style>
</head>
<body>
	<div class="message">
		<div class="spinner"></div>
		<p>Completing sign-in...</p>
	</div>

	<script>
		(function() {
			try {
				// Get URL parameters
				const urlParams = new URLSearchParams(window.location.search);
				const authorizationCode = urlParams.get('code');
				const error = urlParams.get('error');
				const errorDescription = urlParams.get('error_description');
				const state = urlParams.get('state');

				// Detect provider based on URL or state
				let provider = 'unknown';
				if (window.location.search.includes('github.com') || document.referrer.includes('github.com')) {
					provider = 'github';
				} else if (window.location.search.includes('microsoftonline.com') || document.referrer.includes('microsoftonline.com')) {
					provider = 'microsoft';
				}

				// Check for errors first
				if (error) {
					const errorMsg = errorDescription || error || 'OAuth authentication failed';
					
					// Post error message to parent
					if (window.opener) {
						window.opener.postMessage({
							type: `${provider.toUpperCase()}_OAUTH_ERROR`,
							error: errorMsg,
							state: state
						}, window.location.origin);
					}
					
					// Close popup after short delay
					setTimeout(() => {
						window.close();
					}, 1000);
					return;
				}

				// Check for authorization code
				if (authorizationCode) {
					// Post success message to parent
					if (window.opener) {
						window.opener.postMessage({
							type: `${provider.toUpperCase()}_OAUTH_SUCCESS`,
							authorizationCode: authorizationCode,
							state: state
						}, window.location.origin);
					}
					
					// Close popup after short delay
					setTimeout(() => {
						window.close();
					}, 500);
				} else {
					// No code or error - something went wrong
					if (window.opener) {
						window.opener.postMessage({
							type: `${provider.toUpperCase()}_OAUTH_ERROR`,
							error: 'No authorization code received',
							state: state
						}, window.location.origin);
					}
					
					setTimeout(() => {
						window.close();
					}, 1000);
				}

			} catch (err) {
				console.error('OAuth redirect error:', err);
				
				// Post generic error to parent
				if (window.opener) {
					window.opener.postMessage({
						type: 'UNKNOWN_OAUTH_ERROR',
						error: 'OAuth redirect processing failed: ' + err.message
					}, window.location.origin);
				}
				
				setTimeout(() => {
					window.close();
				}, 1000);
			}
		})();
	</script>
</body>
</html>