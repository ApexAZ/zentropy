<!DOCTYPE html>
<html>
<head>
    <title>OAuth Redirect</title>
</head>
<body>
    <script>
        // Prevent multiple executions
        if (window.oauthHandled) {
            // Exit silently if already handled
        } else {
            window.oauthHandled = true;
        
            // Extract parameters from URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            const sessionState = urlParams.get('session_state');
            
            // Determine OAuth provider
            const referrer = document.referrer || '';
            let provider = 'UNKNOWN';
            
            // Primary detection: Check referrer domain
            if (referrer.includes('login.microsoftonline.com') || 
                referrer.includes('login.live.com') || 
                referrer.includes('microsoft')) {
                provider = 'MICROSOFT';
            } else if (referrer.includes('github.com')) {
                provider = 'GITHUB';
            } else if (referrer.includes('accounts.google.com') || 
                       referrer.includes('google')) {
                provider = 'GOOGLE';
            }
            
            // Fallback: Microsoft-specific parameter detection
            if (provider === 'UNKNOWN' && sessionState) {
                provider = 'MICROSOFT';
            }
            
            // Final fallback: Check scope for openid (Microsoft pattern)
            if (provider === 'UNKNOWN') {
                const scope = urlParams.get('scope');
                if (scope && scope.includes('openid')) {
                    provider = 'MICROSOFT';
                }
            }
            
            // Construct message
            let messageData;
            if (code) {
                messageData = {
                    type: `${provider}_OAUTH_SUCCESS`,
                    authorizationCode: code
                };
            } else if (error) {
                messageData = {
                    type: `${provider}_OAUTH_ERROR`,
                    error: errorDescription || error
                };
            } else {
                messageData = {
                    type: `${provider}_OAUTH_ERROR`,
                    error: `No authorization code received from ${provider.toLowerCase()} OAuth`
                };
            }
            
            // Send message to parent window
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage(messageData, window.location.origin);
                    
                    // Close popup after successful message send
                    setTimeout(() => {
                        window.close();
                    }, 500);
                } catch (err) {
                    console.error('Failed to send message to parent:', err);
                }
            }
        }
    </script>
</body>
</html>